<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Daftar Pesanan</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-4">
<h1 class="text-2xl font-bold mb-4">Daftar Pesanan</h1>
<div class="flex flex-col sm:flex-row sm:items-center sm:mb-4 gap-2">
  <input type="text" id="searchOrderID" placeholder="Cari Order ID..." class="p-2 border border-gray-300 rounded w-full sm:w-64">
  <button id="filterLatest" class="p-2 bg-blue-500 text-white rounded hover:bg-blue-600">Tampilkan Terbaru</button>
</div>
<div id="orders" class="flex flex-col gap-4"></div>

<script>
function formatRupiah(angka) {
  if (!angka) return '0';
  return angka.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
}

let allOrders = [];

async function loadOrders() {
  try {
    const response = await fetch('https://opensheet.elk.sh/1UegN4GjZZeZHEierW_dqIfkRZpTwZKb6tQW4YQ85mFw/Sheet1');
    if (!response.ok) {
      console.error('Gagal mengambil data:', response.status, response.statusText);
      document.getElementById('orders').innerHTML = '<p class="text-red-500">Gagal memuat data pesanan.</p>';
      return;
    }

    const textData = await response.text();
    if (!textData) {
      console.error('Response kosong');
      document.getElementById('orders').innerHTML = '<p class="text-red-500">Data pesanan kosong.</p>';
      return;
    }

    try {
      allOrders = JSON.parse(textData);
      if (!Array.isArray(allOrders)) throw new Error('Data bukan array');
      displayOrders(allOrders);
    } catch (err) {
      console.error('JSON tidak valid:', err);
      document.getElementById('orders').innerHTML = '<p class="text-red-500">Format data pesanan tidak valid.</p>';
    }
  } catch (err) {
    console.error('Terjadi kesalahan fetch:', err);
    document.getElementById('orders').innerHTML = '<p class="text-red-500">Tidak dapat mengambil data pesanan.</p>';
  }
}

function displayOrders(orders) {
  const ordersContainer = document.getElementById('orders');
  ordersContainer.innerHTML = '';

  orders.forEach(order => {
    const orderDiv = document.createElement('div');
    orderDiv.className = 'bg-white p-4 rounded shadow';

    orderDiv.innerHTML = `
      <h3 class="text-lg font-semibold mb-2">Order ID: ${order.orderID || '-'}</h3>

      <div class="mb-2 p-2 bg-gray-50 rounded">
        <h4 class="font-medium mb-1">Data Pelanggan</h4>
        <p><strong>Nama:</strong> ${order.nama || '-'}</p>
        <p><strong>Email:</strong> ${order.email || '-'}</p>
        <p><strong>WhatsApp:</strong> ${order.whatsapp || '-'}</p>
        <p><strong>Alamat:</strong> ${order.alamat || '-'}</p>
      </div>

      <div class="mb-2 p-2 bg-gray-50 rounded">
        <h4 class="font-medium mb-1">Metode & Pembayaran</h4>
        <p><strong>Metode Pengiriman:</strong> ${order.metodePengiriman || '-'}</p>
        <p><strong>Metode Pembayaran:</strong> ${order.metodePembayaran || '-'}</p>
        <p><strong>Nomor VA:</strong> ${order.nomorVA || '-'}</p>
      </div>

      <div class="mb-2 p-2 bg-gray-50 rounded">
        <h4 class="font-medium mb-1">Checkout</h4>
        <p><strong>Checkout Total:</strong> Rp ${formatRupiah(order.checkoutTotal)}</p>
        <p><strong>Biaya Pengiriman:</strong> Rp ${formatRupiah(order.biayaPengiriman)}</p>
        <p><strong>Total Checkout + Ongkir:</strong> Rp ${formatRupiah(order.totalBiayaCheckoutPengiriman)}</p>
      </div>

      <div class="mb-2 p-2 bg-gray-50 rounded">
        <h4 class="font-medium mb-1">Items (Checkout Total: Rp ${formatRupiah(order.checkoutTotal)})</h4>
      </div>
    `;

    const itemsSection = document.createElement('div');
    itemsSection.className = 'mb-2 p-2 bg-gray-50 rounded';

    if (order.checkoutItems) {
      try {
        const items = JSON.parse(order.checkoutItems);
        if (Array.isArray(items)) {
          items.forEach(item => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'flex items-center mb-2';
            itemDiv.innerHTML = `
              <img src="${item.image_link}" alt="${item.title}" class="w-16 h-16 object-cover rounded mr-2">
              <div class="flex flex-col text-sm">
                <strong>${item.title}</strong>
                <span>Price: Rp ${formatRupiah(item.price)}</span>
                <span>Color: ${item.color}, Size: ${item.size}</span>
                <span>Brand: ${item.brand}, Gender: ${item.gender}</span>
              </div>
            `;
            itemsSection.appendChild(itemDiv);
          });
        }
      } catch (err) {
        console.error('Gagal parsing checkoutItems:', err);
        itemsSection.innerHTML += '<p class="text-red-500">Items tidak dapat ditampilkan.</p>';
      }
    }

    orderDiv.appendChild(itemsSection);
    ordersContainer.appendChild(orderDiv);
  });
}

// Search by Order ID
document.getElementById('searchOrderID').addEventListener('input', function() {
  const searchTerm = this.value.toLowerCase();
  const filteredOrders = allOrders.filter(order => (order.orderID || '').toLowerCase().includes(searchTerm));
  displayOrders(filteredOrders);
});

// Filter latest orders
document.getElementById('filterLatest').addEventListener('click', function() {
  const sortedOrders = [...allOrders].reverse();
  displayOrders(sortedOrders);
});

loadOrders();
</script>
</body>
</html>
